<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Citation graph</title>
    <style>
      body {
        margin: 0;
        background: #030712;
        color: #e5e7eb;
        font-family: "IBM Plex Sans", "Segoe UI", system-ui, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }
      svg {
        width: 100%;
        height: 100%;
      }
      .edge {
        fill: none;
        stroke: rgba(59, 130, 246, 0.6);
        stroke-width: 2;
      }
      .node-circle {
        cursor: pointer;
        stroke: #0f172a;
        stroke-width: 2;
        fill: #1d4888;
        transition: transform 0.2s ease, stroke 0.2s ease;
      }
      .node-circle:hover {
        transform: scale(1.05);
        stroke: #22d3ee;
      }
      .node-label {
        fill: #e5e7eb;
        font-size: 12px;
        pointer-events: none;
        text-anchor: middle;
      }
    </style>
  </head>
  <body>
    <svg id="graph"></svg>
    <script>
      const svg = document.getElementById("graph");
      const width = 720;
      const height = 420;
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = Math.min(width, height) / 2 - 60;
      let nodes = [];

      const clear = () => {
        while (svg.firstChild) {
          svg.removeChild(svg.firstChild);
        }
      };

      const renderGraph = (payload) => {
        if (!payload) {
          return;
        }
        nodes = payload.nodes ?? [];
        const positions = {};
        clear();
        const total = nodes.length || 1;
        nodes.forEach((node, index) => {
          const angle = (Math.PI * 2 * index) / total;
          const x = centerX + radius * Math.cos(angle);
          const y = centerY + radius * Math.sin(angle);
          positions[node.id] = { x, y };
        });
        (payload.edges ?? []).forEach((edge) => {
          const source = positions[edge.source];
          const target = positions[edge.target];
          if (!source || !target) {
            return;
          }
          const dx = target.x - source.x;
          const dy = target.y - source.y;
          const qx = source.x + dx / 2 - dy * 0.2;
          const qy = source.y + dy / 2 + dx * 0.2;
          const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
          path.setAttribute("d", `M ${source.x} ${source.y} Q ${qx} ${qy} ${target.x} ${target.y}`);
          path.setAttribute("class", "edge");
          path.setAttribute("stroke-width", (edge.weight ?? 1) * 2);
          svg.appendChild(path);
        });
        nodes.forEach((node) => {
          const { x, y } = positions[node.id];
          const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          circle.setAttribute("cx", String(x));
          circle.setAttribute("cy", String(y));
          circle.setAttribute("r", node.type === "selected" ? "20" : "14");
          circle.setAttribute("class", "node-circle");
          circle.addEventListener("click", () => {
            window.parent.postMessage({ type: "graphNodeClick", nodeId: node.id }, "*");
          });
          const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
          label.setAttribute("x", String(x));
          label.setAttribute("y", String(y + 4));
          label.setAttribute("class", "node-label");
          label.textContent = node.label;
          svg.appendChild(circle);
          svg.appendChild(label);
        });
      };

      window.addEventListener("message", (event) => {
        if (event.data?.type === "graph") {
          renderGraph(event.data.payload);
        }
      });
    </script>
  </body>
</html>
