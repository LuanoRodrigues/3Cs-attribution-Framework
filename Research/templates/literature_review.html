<!DOCTYPE html>
<html lang="en"> {# Added lang attribute #}
<head>
  <meta charset="UTF-8">
  {# Use more specific title reflecting RQ if available, fallback to topic #}
  <title>Literature Review: {% if research_question %}{{ research_question[:60] }}...{% else %}{{ topic }}{% endif %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> {# Added viewport for responsiveness #}
  <style>
    /* --- Enhanced and Cleaner Styles --- */
    :root {
      --primary-color: #0D47A1; /* Deep blue */
      --secondary-color: #1E88E5; /* Medium blue */
      --accent-color: #42A5F5; /* Light blue */
      --background-color: #fcfcfc;
      --text-color: #333;
      --muted-text-color: #555;
      --border-color: #e0e0e0;
      --section-border-color: #90CAF9;
      --hover-bg-color: #eff4ff;
      --code-bg-color: #f5f5f5;
      --placeholder-bg: #fdfefe;
      --placeholder-border: #bdc3c7;
      --placeholder-text: #7f8c8d;
      --footnote-link-color: #888;
    }

    body {
      font-family: 'Georgia', serif; /* Switched to serif for main body */
      line-height: 1.8; /* Slightly increased line height */
      margin: 0 auto;
      max-width: 850px; /* Slightly narrower */
      padding: 30px; /* Increased padding */
      color: var(--text-color);
      background-color: var(--background-color);
      font-size: 16px; /* Base font size */
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'Lato', sans-serif; /* Sans-serif for headings */
      margin-top: 2.2em;
      margin-bottom: 1em;
      line-height: 1.3;
      font-weight: 700; /* Bolder headings */
      color: var(--primary-color);
      text-rendering: optimizeLegibility;
    }

    h1 {
      text-align: center;
      margin-bottom: 1.8em;
      font-size: 2.4em; /* Larger main title */
      color: var(--primary-color);
      border-bottom: 3px solid var(--accent-color);
      padding-bottom: 0.5em;
    }

    h2 {
      border-bottom: 2px solid var(--accent-color);
      padding-bottom: 10px;
      font-size: 1.9em;
      color: var(--primary-color);
    }

    h3 {
      border-bottom: 1px solid var(--section-border-color);
      padding-bottom: 8px;
      font-size: 1.5em;
      color: var(--secondary-color);
      font-weight: 600;
    }

    h4 {
      font-size: 1.2em;
      color: var(--accent-color);
      margin-bottom: 0.8em;
      font-weight: 700;
    }

    p {
      margin-bottom: 1.4em;
      text-align: justify;
    }

    a {
      color: var(--secondary-color);
      text-decoration: none;
      transition: color 0.2s ease-in-out;
    }
    a:hover, a:focus {
      color: var(--primary-color);
      text-decoration: underline;
    }

    em, i { font-style: italic; }
    strong, b { font-weight: 700; } /* Slightly bolder strong */

    blockquote {
      border-left: 4px solid var(--accent-color);
      padding-left: 1.5em;
      margin-left: 0;
      margin-right: 0;
      margin-top: 1.5em;
      margin-bottom: 1.5em;
      font-style: italic;
      color: var(--muted-text-color);
    }

    code, pre { /* Basic code styling */
      font-family: 'Menlo', 'Consolas', monospace;
      background-color: var(--code-bg-color);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-size: 0.9em;
    }
    pre {
      padding: 1em;
      overflow-x: auto;
    }

    .metadata {
      text-align: center;
      margin-bottom: 3.5em;
      font-size: 0.9em; /* Slightly smaller */
      color: var(--muted-text-color);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 2em;
      font-family: 'Lato', sans-serif; /* Sans-serif for metadata */
    }
    .metadata p {
      margin: 0.4em 0;
      text-align: center; /* Centered paragraph text */
      line-height: 1.5;
    }

    .section-content {
      margin-bottom: 2.5em; /* Consistent spacing */
      padding-left: 0;
    }

    /* Improved AI Content styling */
    .ai-generated-content {
      padding: 10px 0; /* Added some padding */
      margin: 1.5em 0;
      text-align: justify;
      border: none; /* Removed border */
    }
    .ai-generated-content p:last-child { margin-bottom: 0; }
    .ai-generated-content ul, .ai-generated-content ol {
      margin-left: 1.5em; /* Adjusted indent */
      margin-bottom: 1.4em;
      padding-left: 1em; /* Added padding */
    }
    .ai-generated-content li { margin-bottom: 0.6em; }

    /* Placeholder Styling */
    .ai-placeholder {
      font-style: italic;
      color: var(--placeholder-text);
      border: 1px dashed var(--placeholder-border);
      padding: 1.5em; /* More padding */
      margin: 2em 0;
      background-color: var(--placeholder-bg);
      text-align: center;
      border-radius: 4px;
    }

    /* Review Body Sections */
    .review-body-section { margin-bottom: 3em; }
    .review-body-section h3 { /* Style inherited */ }
    .review-body-section .ai-generated-content { margin-top: 0.5em; padding-top: 0; }

    /* Criteria Box Styling */
    .criteria-box {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      padding: 1.2em 1.5em; /* Adjusted padding */
      margin: 1.5em 0;
      border-radius: 5px;
      font-size: 0.95em;
    }
    .criteria-box h4 {
      margin-top: 0;
      margin-bottom: 1em;
      color: #495057;
      font-size: 1.1em;
      font-family: 'Lato', sans-serif;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 0.5em;
    }
    .criteria-list {
      list-style-type: disc;
      margin-left: 1.2em;
      padding-left: 0.5em;
      line-height: 1.6;
    }
    .criteria-list li { margin-bottom: 0.5em; }

    /* Footnotes Styling */
    #footnotes { margin-top: 3em; padding-top: 1.5em; border-top: 1px solid var(--border-color); }
    #footnotes h2 { margin-bottom: 1.5em; font-size: 1.6em; }
    .footnotes {
        padding-left: 0; /* Reset browser default */
        list-style: none; /* Remove default numbering */
        counter-reset: footnote-counter; /* Initialize counter */
        font-size: 0.9em;
        line-height: 1.6;
        color: var(--muted-text-color);
    }
    .footnotes li {
        counter-increment: footnote-counter; /* Increment counter */
        margin-bottom: 1em;
        padding-left: 2.5em; /* Indent note text */
        position: relative;
    }
    .footnotes li::before { /* Add custom counter */
        content: counter(footnote-counter) ".";
        font-weight: 600;
        position: absolute;
        left: 0.5em;
        top: 0;
        color: var(--secondary-color);
    }
    .footnotes li a { /* Style the jump-back link */
      text-decoration: none;
      color: var(--footnote-link-color);
      margin-right: 0.5em;
      font-weight: bold;
    }
    .footnotes li a:hover { color: var(--primary-color); }

    /* Bibliography Styling */
    #references { margin-top: 3em; padding-top: 1.5em; border-top: 1px solid var(--border-color); }
    #references h2 { margin-bottom: 1.5em; font-size: 1.6em; }
    #references ol {
      list-style: none; /* Remove default numbers */
      padding-left: 0;
      margin-top: 1em;
    }
    #references li {
      margin-bottom: 1.2em;
      padding-left: 1.5em; /* Indent for hanging effect */
      text-indent: -1.5em; /* Create hanging indent */
      font-size: 0.95em;
      line-height: 1.7;
    }
    #references li strong { font-weight: normal; } /* Remove default strong if Zotero adds it */
    #references li em, #references li i { font-style: italic; }

  </style>
</head>
<body>

{# --- Main Title --- #}
<h1>Literature Review: {{ topic }}</h1>

{# --- Metadata Block --- #}
<div class="metadata">
  <p><strong>Authors:</strong> {{ authors_list | default("[Not Specified]") }}</p>
  <p><strong>Affiliations:</strong> {{ affiliation | default("[Not Specified]") }}</p>
  {# Display research question safely #}
  <p><strong>Research Question:</strong><br><em>{{ research_question | default("[Not Specified]") }}</em></p>
  <p>Report generated on: {{ generation_date | default("N/A") }}</p>
  <p>Data Source: Zotero Collection | Processed: {{ num_items_processed | default("N/A") }} items | Screened: {{ num_items_screened | default("N/A") }} | Included: {{ num_items_included | default("N/A") }} | PDFs Coded: {{ num_pdfs_coded | default("N/A") }}</p>
  <p>AI Models Used: {{ ai_models_used | default("[Not Specified]") }}</p>
</div>

{# --- Abstract --- #}
{% if ai_abstract %}
<h2>Abstract</h2>
<div class="section-content ai-generated-content">
     {{ ai_abstract | safe }}
</div>
{% endif %}

{# --- Introduction --- #}
{% if ai_introduction %}
<h2>1. Introduction</h2>
<div class="section-content ai-generated-content">
     {{ ai_introduction | safe }}
</div>
{% else %}
<h2>1. Introduction</h2>
<div class="section-content">
    <p class="ai-placeholder">[Introduction generation failed or skipped.]</p>
</div>
{% endif %}
<!-- 2. METHODOLOGY -->
<h2>2. Methodology</h2>
<div class="section-content">
    {# Revised intro paragraph #}
    <p>This literature review employed a structured process to identify, screen, analyze, and synthesize literature relevant to the research question:</p>
    <blockquote><em>{{ research_question | default("[Research question not specified]") }}</em></blockquote>

    <h3>2.1 Data Source</h3>
    <p>The initial corpus consisted of {{ num_items_processed | default("an unspecified number of") }} bibliographic records derived from a curated Zotero collection focused on "{{ topic | default("the specified topic") }}".</p>

    <h3>2.2 Eligibility Criteria</h3>
    {# Revised paragraph - removed "AI language model ... prompted" #}
    <p>Predefined inclusion and exclusion criteria, developed based on the research question and preliminary abstract review, were applied to select relevant studies. The criteria used for screening were:</p>
    {% if criteria and criteria.inclusion_criteria and criteria.exclusion_criteria %}
    <div class="criteria-box">
        <h4>Inclusion Criteria:</h4>
        <ul class="criteria-list">
            {% for criterion in criteria.inclusion_criteria %}
                <li>{{ criterion }}</li>
            {% else %}
                <li>[No inclusion criteria specified]</li>
            {% endfor %}
        </ul>
        <h4>Exclusion Criteria:</h4>
        <ul class="criteria-list">
             {% for criterion in criteria.exclusion_criteria %}
                <li>{{ criterion }}</li>
             {% else %}
                 <li>[No exclusion criteria specified]</li>
             {% endfor %}
        </ul>
    </div>
    {% else %}
    <p class="ai-placeholder">[Criteria definition failed, skipped, or criteria data is missing.]</p>
    {% endif %}

    <h3>2.3 Study Screening (Title/Abstract)</h3>
    {# Revised paragraph - removed "AI language model" #}
    <p>Titles and abstracts of {{ num_items_screened | default("N/A") }} identified items were screened against the eligibility criteria.</p>
    {# Added excluded count calculation #}
    <p><em>Screening Result: {{ num_items_included | default("N/A") }} items met the criteria for full-text review, while {{ (num_items_screened | default(0)) - (num_items_included | default(0)) }} items were excluded at this stage.</em></p>

    <h3>2.4 Full-Text Analysis (Data Extraction & Coding)</h3>
    {# Revised paragraph - removed "AI language model", rephrased coding #}
    <p>For the {{ num_items_included | default("N/A") }} items included after screening, full texts were retrieved where available. Relevant articles ({{ num_pdfs_coded | default("N/A") }}) were analyzed page-by-page. Key information pertinent to the research question(s)—including direct quotations, conceptual arguments, findings, location context within the source, and associated keywords—was systematically extracted and coded into a structured format.</p>
    {# Removed the specific note about enhanced structure - it's implied by the description #}

    <h3>2.5 Thematic Outline and Argument Clustering</h3>
    {# Revised paragraph - removed "AI analyzed", rephrased clustering #}
    <p>The extracted coded data was analyzed to identify recurring concepts and generate a primary thematic outline for structuring the review. Subsequently, within each major theme, coded notes were further grouped based on specific arguments, claims, or sub-themes to facilitate detailed synthesis.</p>
     <p><strong>Resulting Thematic Outline:</strong></p>
    {% if generated_themes %}
     <ul class="criteria-list">
        {% for theme in generated_themes %}
            <li>{{ theme }}</li>
        {% else %}
             <li>[No themes generated or provided.]</li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="ai-placeholder">[Theme/Outline generation failed or skipped.]</p>
    {% endif %}

     <h3>2.6 Content Synthesis and Narrative Generation</h3>
     {# Revised paragraph - removed "AI integrated citations", focused on process #}
     <p>Narrative synthesis was conducted paragraph-by-paragraph. Each paragraph focused on synthesizing the coded data clustered under a specific argument identified in the previous step. Citations were systematically incorporated during synthesis using placeholders linked to the extracted source information. Finally, the Abstract, Introduction, Conclusion, and Limitations sections were drafted based on the synthesized content and overall review findings.</p>
     {# Removed Transparency Note #}
</div>

{# --- Literature Review Body --- #}
{# Assumes section numbers start from 3 #}
<h2>3. Literature Review Findings</h2>
<div class="section-content">
    <p>The following sections synthesize the findings from the analyzed literature, structured according to the generated thematic outline and the arguments clustered within each theme.</p>

    {% if generated_sections and generated_themes %}
        {# Iterate based on the order in generated_themes to ensure logical flow #}
        {% for section_title in generated_themes %}
            <div class="review-body-section">
                {# Use loop.index + 2 to start numbering from 3 #}
                <h3>{{ loop.index + 2 }}. {{ section_title }}</h3>
                {% if section_title in generated_sections and generated_sections[section_title] and not '[No content generated' in generated_sections[section_title] and not '[ERROR' in generated_sections[section_title] %}
                    <div class="ai-generated-content">
                        {# Apply safe filter as content contains HTML <sup> tags #}
                        {{ generated_sections[section_title] | safe }}
                    </div>
                {% else %}
                     <p class="ai-placeholder">[Content for this theme/section could not be generated or was empty.]</p>
                {% endif %}
            </div>
        {% endfor %} {# End loop through generated_themes #}
    {% else %}
        <p class="ai-placeholder">[Main body sections could not be generated or themes were not defined.]</p>
    {% endif %} {# End check for generated_sections and generated_themes #}
</div>

{# --- Conclusion --- #}
{# Adjust numbering based on number of sections + 3 #}
<h2>{{ (generated_themes | length) + 3 }}. Conclusion</h2>
<div class="section-content ai-generated-content">
  {% if ai_conclusion %}
     {{ ai_conclusion | safe }}
  {% else %}
     <p class="ai-placeholder">[Conclusion generation failed or skipped.]</p>
  {% endif %}
</div>

{# --- Limitations --- #}
<h2>{{ (generated_themes | length) + 4 }}. Limitations</h2>
<div class="section-content ai-generated-content">
  {% if ai_limitations %}
    {# Assuming limitations might be paragraph(s) #}
    {{ ai_limitations | safe }}
  {% else %}
     <p class="ai-placeholder">[Limitations section not generated.]</p>
  {% endif %}
</div>

{# --- Footnotes Section --- #}
<div id="footnotes">
    <h2>Notes</h2>
    {% if footnote_list_texts %}
        <ol class="footnotes">
        {# Sort by footnote ID (numeric key) before iterating #}
        {% for fn_id, fn_text in footnote_list_texts.items()|sort %}
          <li id="fn-{{ fn_id }}">
            <a href="#fnref-{{ fn_id }}" title="Jump back to citation">^</a>
            {# Use safe filter because footnote text might contain HTML (like <em>) #}
            {{ fn_text|safe }}
          </li>
        {% endfor %}
        </ol>
    {% else %}
        <p>No footnotes were generated or required for this review.</p>
    {% endif %}
</div>

{# --- Bibliography Section --- #}
<div id="references">
    <h2>Bibliography</h2>
    {% if references_list %}
        <ol>
        {% for ref in references_list %}
            <li>{{ ref | safe }}</li> {# Use safe if refs contain HTML #}
        {% else %}
            <li>[No references included in the final list.]</li>
        {% endfor %}
        </ol>
    {% else %}
        <p>[Bibliography could not be generated or is empty.]</p>
    {% endif %}
</div>

</body>
</html>