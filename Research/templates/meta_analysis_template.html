<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Systematic Review and Meta-Analysis on {{ topic }}</title>
  <style>
    /* --- Base & Typography --- */
    body { font-family: sans-serif; line-height: 1.7; margin: 0 auto; max-width: 900px; padding: 25px; color: #333; background-color: #fdfdfd; }
    h1, h2, h3, h4 { font-family: "Georgia", serif; color: #1A237E; margin-top: 2em; margin-bottom: 0.8em; line-height: 1.3; font-weight: 600; }
    h1 { text-align: center; margin-bottom: 1.5em; font-size: 2.2em; color: #0D47A1; }
    h2 { border-bottom: 2px solid #42A5F5; padding-bottom: 8px; font-size: 1.8em; }
    h3 { border-bottom: 1px solid #90CAF9; padding-bottom: 6px; font-size: 1.5em; color: #1E88E5; }
    h4 { font-size: 1.2em; color: #42A5F5; margin-bottom: 0.6em; font-weight: 600; font-family: sans-serif; }
    p { margin-bottom: 1.2em; text-align: justify; }
    a { color: #1E88E5; text-decoration: none; }
    a:hover { color: #0D47A1; text-decoration: underline; }
    em, i { font-style: italic; }
    strong, b { font-weight: 600; }

    /* --- Layout & Sections --- */
    .metadata { text-align: center; margin-bottom: 3em; font-size: 0.95em; color: #555; border-bottom: 1px solid #e0e0e0; padding-bottom: 1.5em; }
    .metadata p { margin: 0.3em 0; }
    .section-content { margin-bottom: 40px; padding-left: 0; }
    .subsection-content { margin-bottom: 30px; padding-left: 15px; border-left: 3px solid #E3F2FD; margin-left: 5px; }

    /* --- Visual Elements --- */
    figure { margin: 35px auto; text-align: center; border: 1px solid #e0e0e0; padding: 15px 15px 10px 15px; background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.08); max-width: 800px; }
    figure img { max-width: 100%; height: auto; border: 1px solid #f0f0f0; display: block; margin: 0 auto 10px auto; }
    figcaption { font-size: 0.9em; color: #666; margin-top: 10px; font-style: normal; line-height: 1.5; text-align: left; padding: 0 5px; }
    figcaption strong { color: #333; }

    table.data-table { border-collapse: collapse; width: 100%; margin: 30px auto; border: 1px solid #ccc; box-shadow: none; font-size: 0.88em; }
    table.data-table th, table.data-table td { border: 1px solid #ddd; padding: 10px 12px; text-align: left; vertical-align: top; }
    table.data-table th { background-color: #f2f7fb; font-weight: 600; color: #2c3e50; }
    table.data-table tr:nth-child(even) { background-color: #f9f9f9; }
    table.data-table tr:hover { background-color: #eff4ff; }

    /* --- Content Blocks --- */
    .ai-generated-content { font-style: normal; color: #333; padding: 5px 0px; margin: 15px 0; background-color: transparent; text-align: justify; border: none; }
    .ai-generated-content p { margin-bottom: 1em; }
    .ai-generated-content p:first-child { margin-top: 0; }
    .ai-generated-content p:last-child { margin-bottom: 0; }
    .ai-generated-content ul, .ai-generated-content ol { margin-left: 20px; margin-bottom: 1em; }
    .ai-generated-content li { margin-bottom: 0.5em; }

    .ai-placeholder { font-style: italic; color: #7f8c8d; border: 1px dashed #bdc3c7; padding: 15px; margin: 20px 0; background-color: #fdfefe; text-align: center; }
    .placeholder-note { color: #888; font-style: italic; font-size: 0.9em; display: block; margin-top: 8px; text-align: center; }
    .appendix-link { display: block; margin-top: 15px; font-weight: bold; }

    /* --- Meta-analysis Specific --- */
    .structured-abstract h4 { font-size: 1.1em; color: #1E88E5; margin-top: 1em; margin-bottom: 0.3em; font-family: sans-serif; font-weight: 600; border: none; padding: 0;}
    .structured-abstract p { margin-left: 15px; }

    .prisma-diagram { max-width: 650px; }
    .rob-plot { max-width: 800px; }

    .forest-plot { max-width: 880px; }
    .funnel-plot { max-width: 700px; }
    .network-plot { max-width: 780px; }
    .rankogram-plot { max-width: 880px; }
    .bubble-plot { max-width: 780px; }
    .influence-plot { max-width: 780px; }
    .baujat-plot { max-width: 780px; }
    .labbe-plot { max-width: 780px; }

    .callout { border-left: 4px solid #42A5F5; background: #F5FAFF; padding: 12px 14px; margin: 18px 0; }
    .callout strong { color: #0D47A1; }
  </style>
</head>
<body>

<h1>Systematic Review and Meta-Analysis: {{ topic }}</h1>

<div class="metadata">
  <p><strong>Authors:</strong> {{ authors_list }}</p>
  <p><strong>Affiliations:</strong> {{ affiliation }}</p>
  <p><em>Report generated on: {{ generation_date }}</em></p>
  <p><em>AI Models Used for Narrative Sections: {{ ai_models_used }}</em></p>
  {% if protocol_registration %}
    <p><em>Protocol/Registration: {{ protocol_registration }}</em></p>
  {% endif %}
</div>

<h2>Abstract</h2>
<div class="section-content ai-generated-content structured-abstract">
  {# Suggested headings inside ai_abstract: Background, Objectives, Data Sources, Inclusion Logic, Methods, Results, Limitations, Conclusions #}
  {{ ai_abstract | safe }}
</div>

<h2>1. Introduction</h2>
<div class="section-content ai-generated-content">
  {{ ai_introduction | safe }}
</div>

<h2>2. Methods</h2>
<div class="section-content">

  <div class="subsection-content">
    <div class="ai-generated-content">
      <p><strong>Corpus construction / inclusion logic:</strong><br>
        {% if inclusion_logic %}
          {{ inclusion_logic | replace('\n', '<br>') | safe }}
        {% else %}
          <span class="placeholder-note">[Define inclusion logic appropriate to IR/CS (e.g., unit of analysis, evidentiary threshold, time range, venue types).]</span>
        {% endif %}
      </p>

      <p><strong>Information sources and search strategy:</strong><br>
        {% if search_strategy_summary %}
          {{ search_strategy_summary | safe }}
        {% else %}
          <span class="placeholder-note">[Describe sources: databases, archives, repositories, bibliographic snowballing, expert elicitation, etc.]</span>
        {% endif %}
      </p>

      {% if full_search_strategy_appendix_path %}
        <p class="appendix-link"><a href="{{ full_search_strategy_appendix_path }}" target="_blank">Link to Full Search Strategy Appendix</a></p>
      {% endif %}

      <p><strong>Screening and selection workflow:</strong><br>
        {% if selection_workflow %}
          {{ selection_workflow | replace('\n', '<br>') | safe }}
        {% else %}
          <span class="placeholder-note">[Describe screening stages and how disagreements were resolved (if relevant).]</span>
        {% endif %}
      </p>

      <p><strong>Data extraction and coding:</strong><br>
        {% if extraction_and_coding %}
          {{ extraction_and_coding | safe }}
        {% else %}
          <span class="placeholder-note">[Define extraction fields, coding scheme, inter-coder reliability (if applicable), and provenance tracking.]</span>
        {% endif %}
      </p>

      {% if data_extraction_appendix_path %}
        <p class="appendix-link"><a href="{{ data_extraction_appendix_path }}" target="_blank">Link to Extraction Form / Codebook</a></p>
      {% endif %}

      <p><strong>Study quality / validity threats assessment (optional):</strong><br>
        {% if validity_assessment %}
          {{ validity_assessment | safe }}
        {% else %}
          <span class="placeholder-note">[Optional: operationalize threats to validity (selection bias, measurement validity, confounding, reporting bias, reproducibility).]</span>
        {% endif %}
      </p>

      <div class="callout">
        <strong>Effect size construction:</strong><br>
        {% if effect_size_definition %}
          {{ effect_size_definition | safe }}
        {% else %}
          <span class="placeholder-note">[Define effect size(s) used (e.g., log(OR), SMD/Hedges g, Fisher z for correlations, incidence rates, etc.) and directionality.]</span>
        {% endif %}
        <br><br>
        <strong>Primary effect measure:</strong>
        {% if effect_measure %} {{ effect_measure }} {% else %} <span class="placeholder-note">[e.g., log(OR), SMD, Fisher z]</span> {% endif %}
        <br>
        <strong>Direction of effect:</strong>
        {% if effect_direction_note %} {{ effect_direction_note }} {% else %} <span class="placeholder-note">[Define what “positive” means in your IR/CS construct space.]</span> {% endif %}
      </div>

      <p><strong>Statistical synthesis (pairwise meta-analysis):</strong><br>
        {% if meta_analysis_methods %}
          {{ meta_analysis_methods | safe }}
        {% else %}
          <ul>
            <li><strong>Model:</strong> {{ meta_model }}</li>
            <li><strong>Estimator (random-effects):</strong> {{ tau_estimator }}</li>
            <li><strong>Weighting:</strong> {{ weighting_scheme }}</li>
            <li><strong>Heterogeneity metrics:</strong> {{ heterogeneity_metrics }}</li>
            <li><strong>Software:</strong> {{ software_used }}</li>
          </ul>
        {% endif %}
      </p>

      <p><strong>Robustness and diagnostics:</strong><br>
        {% if diagnostics_plan %}
          {{ diagnostics_plan | safe }}
        {% else %}
          <ul>
            <li>Influence / leave-one-out sensitivity</li>
            <li>Outlier and heterogeneity diagnostics (as applicable)</li>
            <li>Small-study effects / reporting bias proxies (when feasible)</li>
            <li>Alternative specifications (e.g., different τ estimators, fixed vs random effects)</li>
          </ul>
        {% endif %}
      </p>

      <p><strong>Network meta-analysis / network synthesis (optional):</strong><br>
        {% if nma_methods %}
          {{ nma_methods | safe }}
        {% else %}
          <span class="placeholder-note">[Optional: define network model, transitivity assumptions, consistency checks, and ranking (SUCRA/P-score) if you actually do NMA.]</span>
        {% endif %}
      </p>

    </div>
  </div>

</div>

<h2>3. Results</h2>
<div class="section-content">

  <h3>3.1 Study Selection</h3>
  <div class="subsection-content">
    <p>The literature search identified {{ prisma_n_db }} records from databases/sources. After removing {{ prisma_n_dup }} duplicates, {{ prisma_n_initial_screen }} records were screened based on title and abstract. Of these, {{ prisma_n_screen_exclude }} were excluded. The full texts of the remaining {{ prisma_n_elig_assess }} items were assessed for eligibility. {{ prisma_n_elig_exclude }} full-text items were excluded for the following reasons:</p>
    <ul>
      {% for reason, count in prisma_exclusion_reasons.items() %}
        <li>{{ reason }}: {{ count }}</li>
      {% else %}
        <li>No specific exclusion reasons tagged/available.</li>
      {% endfor %}
    </ul>
    <p>A total of <strong>{{ prisma_n_included }}</strong> studies/items were included in the qualitative synthesis.</p>
    <p>A total of <strong>{{ meta_n_included }}</strong> studies/items contributed to at least one quantitative synthesis (some outcomes may use subsets).</p>

    <figure class="prisma-diagram">
      <div class="plot-container">
        {% if prisma_flow_diagram %}
          <img src="{{ prisma_flow_diagram }}" alt="Flow Diagram">
        {% else %}
          <span class="placeholder-note">[Flow diagram placeholder (optional)]</span>
        {% endif %}
      </div>
      <figcaption><strong>Figure 1.</strong> Study/item selection flow.</figcaption>
    </figure>
  </div>

  <h3>3.2 Study/Source Characteristics</h3>
  <div class="subsection-content">
    <p>The characteristics of the included corpus are summarized below.</p>
    {% if characteristics_table %}
      {{ characteristics_table | safe }}
      <figcaption><strong>Table 1.</strong> Summary of included corpus characteristics.</figcaption>
    {% else %}
      <span class="placeholder-note">[Provide study/source characteristics table as HTML.]</span>
    {% endif %}
  </div>

  <h3>3.3 Validity Threats / Quality Signals (Optional)</h3>
  <div class="subsection-content">
    <p>This section summarizes assessed validity threats or quality signals (if conducted).</p>

    <figure class="rob-plot">
      <div class="plot-container">
        {% if risk_of_bias_plot %}
          <img src="{{ risk_of_bias_plot }}" alt="Quality/Validity Summary Plot">
        {% else %}
          <span class="placeholder-note">[Quality/validity plot placeholder]</span>
        {% endif %}
      </div>
      <figcaption><strong>Figure 2.</strong> Summary of quality/validity judgments (optional; adapt to IR/CS).</figcaption>
    </figure>

    {% if risk_of_bias_table %}
      {{ risk_of_bias_table | safe }}
      <figcaption><strong>Table 2.</strong> Quality/validity detail/summary table (optional).</figcaption>
    {% endif %}
  </div>

  <h3>3.4 Results of Individual Studies/Items (Optional)</h3>
  <div class="subsection-content">
    {% if individual_study_results_table %}
      {{ individual_study_results_table | safe }}
      <figcaption><strong>Table 3.</strong> Individual study/item results (effect sizes and key outcomes), if compiled.</figcaption>
    {% else %}
      <span class="placeholder-note">[Optional: Provide an individual-results table (effect sizes per outcome/comparison).]</span>
    {% endif %}
  </div>

  <h3>3.5 Pairwise Meta-Analysis Results</h3>
  <div class="subsection-content">
    <p>This section reports pooled effects and heterogeneity for each pairwise meta-analysis.</p>

    {% if meta_analyses %}
      {% for ma in meta_analyses %}
        <h4>{{ ma.outcome_name }}{% if ma.comparison %} ({{ ma.comparison }}){% endif %}</h4>

        <div class="ai-generated-content">
          <p>
            <strong>Effect measure:</strong> {{ ma.effect_measure }}<br>
            <strong>Model:</strong> {{ ma.model }}{% if ma.tau_estimator %} (τ estimator: {{ ma.tau_estimator }}){% endif %}<br>
            <strong>Studies/items (k):</strong> {{ ma.k }}<br>
            <strong>Pooled effect:</strong> {{ ma.pooled_effect }} ({{ ma.ci_95 }}){% if ma.p_value %}, p={{ ma.p_value }}{% endif %}<br>
            {% if ma.heterogeneity %}
              <strong>Heterogeneity:</strong> {{ ma.heterogeneity }}
            {% else %}
              <strong>Heterogeneity:</strong> <span class="placeholder-note">[e.g., I², τ², Q]</span>
            {% endif %}
          </p>
        </div>

        <figure class="forest-plot">
          <div class="plot-container">
            {% if ma.forest_plot %}
              <img src="{{ ma.forest_plot }}" alt="Forest plot for {{ ma.outcome_name }}">
            {% else %}
              <span class="placeholder-note">[Forest plot placeholder for {{ ma.outcome_name }}]</span>
            {% endif %}
          </div>
          <figcaption><strong>Figure 2.{{ loop.index }}.</strong> Forest plot for {{ ma.outcome_name }}{% if ma.comparison %} ({{ ma.comparison }}){% endif %}.</figcaption>
        </figure>

        {% if ma.prediction_interval %}
          <div class="callout"><strong>Prediction interval:</strong> {{ ma.prediction_interval }}</div>
        {% endif %}

        {% if ma.subgroup_results %}
          <div class="callout">
            <strong>Subgroup results (optional):</strong>
            <div class="ai-generated-content">{{ ma.subgroup_results | safe }}</div>
          </div>
        {% endif %}

        {% if ma.sensitivity_results %}
          <div class="callout">
            <strong>Sensitivity analyses (optional):</strong>
            <div class="ai-generated-content">{{ ma.sensitivity_results | safe }}</div>
          </div>
        {% endif %}

        {% if ma.meta_regression_summary %}
          <div class="callout">
            <strong>Meta-regression (optional):</strong>
            <div class="ai-generated-content">{{ ma.meta_regression_summary | safe }}</div>
          </div>
        {% endif %}

      {% endfor %}
    {% else %}
      <span class="placeholder-note">[No pairwise meta-analyses provided. Supply meta_analyses as a list of outcome objects.]</span>
    {% endif %}
  </div>

  <h3>3.6 Network Synthesis (Optional)</h3>
  <div class="subsection-content">
    <p>This section reports results from a network synthesis / network meta-analysis when a connected comparison network exists.</p>

    <figure class="network-plot">
      <div class="plot-container">
        {% if evidence_network_figure %}
          <img src="{{ evidence_network_figure }}" alt="Evidence network graph">
        {% else %}
          <span class="placeholder-note">[Evidence network graph placeholder]</span>
        {% endif %}
      </div>
      <figcaption><strong>Figure 3.</strong> Evidence network graph (nodes=conditions; edges=direct comparisons; edge thickness may reflect evidence volume).</figcaption>
    </figure>

    {% if nma_summary_text %}
      <div class="ai-generated-content">{{ nma_summary_text | safe }}</div>
    {% else %}
      <span class="placeholder-note">[Optional: Provide a narrative network-synthesis summary (assumptions, main contrasts, uncertainty).]</span>
    {% endif %}

    {% if nma_league_table %}
      {{ nma_league_table | safe }}
      <figcaption><strong>Table 4.</strong> League table of relative effects from network synthesis (define direction explicitly).</figcaption>
    {% else %}
      <span class="placeholder-note">[Optional: Provide a network league table as HTML.]</span>
    {% endif %}

    {% if ranking_table %}
      {{ ranking_table | safe }}
      <figcaption><strong>Table 5.</strong> Ranking summary (e.g., SUCRA/P-score, mean rank) (optional).</figcaption>
    {% endif %}

    <figure class="rankogram-plot">
      <div class="plot-container">
        {% if rankograms_figure %}
          <img src="{{ rankograms_figure }}" alt="Rankograms">
        {% else %}
          <span class="placeholder-note">[Rankograms figure placeholder]</span>
        {% endif %}
      </div>
      <figcaption><strong>Figure 4.</strong> Rankograms or cumulative ranking curves (optional).</figcaption>
    </figure>

    {% if inconsistency_results %}
      <div class="callout">
        <strong>Consistency / inconsistency assessment:</strong>
        <div class="ai-generated-content">{{ inconsistency_results | safe }}</div>
      </div>
    {% endif %}
  </div>

  <h3>3.7 Small-Study Effects / Reporting Bias (Optional Graphs)</h3>
  <div class="subsection-content">
    <figure class="funnel-plot">
      <div class="plot-container">
        {% if funnel_plot %}
          <img src="{{ funnel_plot }}" alt="Funnel plot">
        {% else %}
          <span class="placeholder-note">[Funnel plot placeholder]</span>
        {% endif %}
      </div>
      <figcaption><strong>Figure 5.</strong> Funnel plot (where applicable) as a diagnostic for small-study effects/reporting bias.</figcaption>
    </figure>

    {% if contour_funnel_plot %}
      <figure class="funnel-plot">
        <div class="plot-container">
          <img src="{{ contour_funnel_plot }}" alt="Contour-enhanced funnel plot">
        </div>
        <figcaption><strong>Figure 6.</strong> Contour-enhanced funnel plot (optional).</figcaption>
      </figure>
    {% endif %}

    {% if trim_and_fill_plot %}
      <figure class="funnel-plot">
        <div class="plot-container">
          <img src="{{ trim_and_fill_plot }}" alt="Trim-and-fill plot">
        </div>
        <figcaption><strong>Figure 7.</strong> Trim-and-fill adjusted funnel plot (optional).</figcaption>
      </figure>
    {% endif %}

    <div class="ai-generated-content">
      {% if pub_bias_results %}
        {{ pub_bias_results | safe }}
      {% else %}
        <span class="placeholder-note">[Optional: report diagnostics/tests and interpret cautiously given IR/CS publication ecology.]</span>
      {% endif %}
    </div>
  </div>

  <h3>3.8 Heterogeneity and Influence Diagnostics (Optional Graphs)</h3>
  <div class="subsection-content">
    {% if influence_plot %}
      <figure class="influence-plot">
        <div class="plot-container">
          <img src="{{ influence_plot }}" alt="Influence diagnostics plot">
        </div>
        <figcaption><strong>Figure 8.</strong> Influence diagnostics (optional).</figcaption>
      </figure>
    {% endif %}

    {% if baujat_plot %}
      <figure class="baujat-plot">
        <div class="plot-container">
          <img src="{{ baujat_plot }}" alt="Baujat plot">
        </div>
        <figcaption><strong>Figure 9.</strong> Baujat plot (optional).</figcaption>
      </figure>
    {% endif %}

    {% if labbe_plot %}
      <figure class="labbe-plot">
        <div class="plot-container">
          <img src="{{ labbe_plot }}" alt="L'Abbé plot">
        </div>
        <figcaption><strong>Figure 10.</strong> L'Abbé plot (optional; for binary outcomes).</figcaption>
      </figure>
    {% endif %}

    {% if bubble_plot %}
      <figure class="bubble-plot">
        <div class="plot-container">
          <img src="{{ bubble_plot }}" alt="Meta-regression bubble plot">
        </div>
        <figcaption><strong>Figure 11.</strong> Meta-regression bubble plot (optional).</figcaption>
      </figure>
    {% endif %}

    {% if diagnostics_summary %}
      <div class="callout">
        <strong>Diagnostics summary:</strong>
        <div class="ai-generated-content">{{ diagnostics_summary | safe }}</div>
      </div>
    {% else %}
      <span class="placeholder-note">[Optional: summarize diagnostics and implications for inference.]</span>
    {% endif %}
  </div>

</div>

<h2>4. Discussion</h2>
<div class="section-content ai-generated-content">
  {% if ai_discussion %}
    {{ ai_discussion | safe }}
  {% else %}
    <p class="ai-placeholder">[AI-generated Discussion section could not be generated.]</p>
  {% endif %}
</div>

<h2>5. Limitations</h2>
<div class="section-content ai-generated-content">
  {% if ai_limitations %}
    {{ ai_limitations | safe }}
  {% else %}
    <p class="ai-placeholder">[Limitations placeholder.]</p>
  {% endif %}
</div>

<h2>6. Conclusion</h2>
<div class="section-content ai-generated-content">
  {% if ai_conclusion %}
    {{ ai_conclusion | safe }}
  {% else %}
    <p class="ai-placeholder">[Conclusion placeholder.]</p>
  {% endif %}
</div>

<h2>7. References</h2>
<div id="references" class="section-content">
  <p>References cited within this review.</p>
  {% if references_list %}
    <ol>
      {% for ref in references_list %}
        <li>{{ ref.html_string | safe }}</li>
      {% endfor %}
    </ol>
  {% else %}
    <ol>
      <li>[References list placeholder — supply formatted references as HTML strings.]</li>
    </ol>
  {% endif %}
</div>

{% if appendices %}
<h2>Appendices</h2>
<div class="section-content">
  {% for app in appendices %}
    <h3>{{ app.title }}</h3>
    <div class="ai-generated-content">
      {{ app.content | safe }}
    </div>
    {% if app.path %}
      <p class="appendix-link"><a href="{{ app.path }}" target="_blank">Open Appendix</a></p>
    {% endif %}
  {% endfor %}
</div>
{% endif %}

</body>
</html>