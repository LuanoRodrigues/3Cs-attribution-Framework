{
  "layoutId": "ribbonLayout",
  "version": 3,
  "goal": "Rebuild a Word-fidelity ribbon in Electron using deterministic, config-driven DOM/CSS with collapse stages, RTE extensions, and Word-like document layout controls (page size/orientation/margins).",
  "successCriteria": [
    "Visual fidelity: ribbon heights, spacing, separators, grouping, and titles match Word at 100% zoom.",
    "Deterministic behavior: layout/collapse are driven by JSON config (no heuristic hiding beyond configured rules).",
    "Functional completeness: Home/Insert/View tabs render and dispatch commands; menus/flyouts never clip.",
    "Electron compatibility: renderer-process DOM/CSS works across window sizes and DPI scale factors.",
    "Extensibility: new tabs/groups/controls can be added without modifying layout engine code.",
    "Document layout parity: page size, orientation, and margin presets mirror Word options and drive on-screen pagination/print metrics deterministically."
  ],
  "scope": {
    "inScope": [
      "TabStrip rendering (tabs, selection, keyboard navigation)",
      "TabPanel rendering (groups, clusters, controls)",
      "Deterministic collapse stages A/B/C and overflow routing",
      "Group overflow menus and group flyouts",
      "Portal-based menu/flyout layering",
      "Z-index plan for ribbon/menus/modals",
      "CSS tokens and structural layout primitives",
      "Command dispatch wiring and state bindings (render contract)",
      "Separator strategy (DOM separators or pseudo separators, configured)",
      "Density modes (comfortable/compact) driven by tokens",
      "Theme modes (light/dark) driven by tokens",
      "Word-like document layout header keys (page size, orientation, margins, gutter, header/footer distances) feeding pagination/print metrics"
    ],
    "outOfScope": [
      "Editor document model and formatting semantics",
      "Command implementation details (business logic)",
      "Localization and RTL",
      "Touch-first ribbon variant",
      "Full accessibility theming beyond baseline ARIA"
    ]
  },
  "assumptions": [
    "ribbon.json and per-tab JSON files are complete and valid; missing required fields must throw.",
    "Icons are provided as SVG strings via resolveIcon(iconKey).",
    "The editor surface exists and is not part of this implementation.",
    "CSS tokens are applied to :root before first ribbon render.",
    "Menus/flyouts are rendered into a portal attached to document.body.",
    "Document layout settings are stored in a single source of truth (app state) and applied to pagination + print preview via the same measured metrics."
  ],
  "regions": [
    {
      "regionId": "titlebar",
      "label": "Title/App Bar",
      "enabledByDefault": false,
      "notes": "Owned by the application shell; should not overlap ribbon controls."
    },
    {
      "regionId": "ribbon",
      "label": "Ribbon",
      "children": [
        {
          "regionId": "tabstrip",
          "label": "Tab Strip",
          "cssClass": "leditor-ribbon-tabs",
          "heightVar": "--r-tabstrip-height",
          "aria": { "role": "tablist", "label": "Ribbon tabs" }
        },
        {
          "regionId": "panel",
          "label": "Ribbon Panel",
          "cssClass": "leditor-ribbon-panel",
          "heightVar": "--r-panel-height",
          "children": [
            {
              "regionId": "groups",
              "label": "Groups Strip",
              "cssClass": "leditor-ribbon-groups",
              "scrollFallback": true,
              "separatorStrategyRef": "defaultGroupSeparators"
            }
          ]
        }
      ]
    },
    {
      "regionId": "editor",
      "label": "Editor Surface",
      "notes": "Existing application content; ribbon overlays must not clip menus."
    }
  ],
  "modes": {
    "density": {
      "default": "comfortable",
      "options": ["comfortable", "compact"],
      "tokenOverrides": {
        "compact": {
          "tabstripHeight": "32px",
          "panelHeight": "112px",
          "panelPadX": "8px",
          "panelPadY": "6px",
          "groupGap": "8px",
          "groupPad": "6px",
          "controlHeightSmall": "22px",
          "controlHeightMedium": "26px",
          "controlHeightLarge": "50px",
          "iconSize": "16px",
          "iconSizeLarge": "18px",
          "chrome": {
            "tabActiveUnderlineHeight": "3px",
            "tabCornerRadius": "6px",
            "groupCornerRadius": "8px",
            "separatorThickness": "1px",
            "separatorInsetY": "6px",
            "panelTopInset": "0px"
          }
        },
        "comfortable": {}
      }
    },
    "theme": {
      "default": "light",
      "options": ["light", "dark"],
      "tokenOverrides": {
        "dark": {
          "colors": {
            "bg": "rgba(25, 27, 33, 0.96)",
            "surface": "rgba(18, 18, 20, 0.95)",
            "surface2": "rgba(255, 255, 255, 0.05)",
            "text": "rgba(255,255,255,0.92)",
            "muted": "rgba(255,255,255,0.68)",
            "disabled": "rgba(255,255,255,0.38)",
            "hover": "rgba(255,255,255,0.06)",
            "pressed": "rgba(255,255,255,0.10)",
            "accent": "#7aa6ff",
            "selected": "rgba(122,166,255,0.18)",
            "focus": "#7aa6ff"
          },
          "border": "1px solid rgba(255,255,255,0.12)",
          "divider": "1px solid rgba(255,255,255,0.10)",
          "shadow": "0 1px 2px rgba(0,0,0,0.40), 0 12px 32px rgba(0,0,0,0.60)"
        },
        "light": {}
      }
    }
  },
  "tokens": {
    "fontFamily": "system-ui, -apple-system, \"Segoe UI\", Roboto, Arial, sans-serif",
    "fontSize": "12px",
    "fontSizeSmall": "11px",
    "lineHeight": 1.2,
    "tabstripHeight": "36px",
    "panelHeight": "120px",
    "panelPadX": "10px",
    "panelPadY": "8px",
    "groupGap": "10px",
    "groupPad": "8px",
    "groupMinWidth": "108px",
    "groupMaxWidth": "380px",
    "controlHeightSmall": "24px",
    "controlHeightMedium": "28px",
    "controlHeightLarge": "54px",
    "controlRadius": "6px",
    "controlGap": "6px",
    "iconSize": "16px",
    "iconSizeLarge": "20px",
    "radius": "10px",
    "border": "1px solid rgba(0,0,0,0.10)",
    "divider": "1px solid rgba(0,0,0,0.08)",
    "shadow": "0 1px 2px rgba(0,0,0,0.10), 0 8px 24px rgba(0,0,0,0.08)",
    "chrome": {
      "tabActiveUnderlineHeight": "3px",
      "tabCornerRadius": "6px",
      "groupCornerRadius": "8px",
      "separatorThickness": "1px",
      "separatorInsetY": "8px",
      "panelTopInset": "0px"
    },
    "colors": {
      "bg": "#f6f7f9",
      "surface": "#ffffff",
      "surface2": "#f1f3f6",
      "text": "rgba(0,0,0,0.88)",
      "muted": "rgba(0,0,0,0.60)",
      "disabled": "rgba(0,0,0,0.35)",
      "hover": "rgba(0,0,0,0.06)",
      "pressed": "rgba(0,0,0,0.10)",
      "accent": "#2563eb",
      "selected": "rgba(37,99,235,0.14)",
      "focus": "#2563eb"
    },
    "motion": {
      "ease": "cubic-bezier(.2,.8,.2,1)",
      "d1": "120ms",
      "d2": "180ms"
    },
    "document": {
      "unit": "in",
      "dpi": 96,
      "pageGapPx": 18,
      "pageOuterShadow": "0 1px 2px rgba(0,0,0,0.10), 0 10px 28px rgba(0,0,0,0.12)",
      "pageBorder": "1px solid rgba(0,0,0,0.10)",
      "canvasBg": "#f3f4f6",
      "contentBg": "#ffffff"
    }
  },
  "documentLayout": {
    "version": 1,
    "stateKeys": {
      "pageSizePreset": "doc.page.sizePreset",
      "orientation": "doc.page.orientation",
      "marginsPreset": "doc.page.marginsPreset",
      "marginsCustom": "doc.page.marginsCustom",
      "gutter": "doc.page.gutter",
      "gutterPosition": "doc.page.gutterPosition",
      "headerDistance": "doc.header.distance",
      "footerDistance": "doc.footer.distance",
      "differentFirstPage": "doc.headerFooter.differentFirstPage",
      "differentOddEven": "doc.headerFooter.differentOddEven"
    },
    "pageSizePresets": [
      { "id": "letter", "label": "Letter", "widthIn": 8.5, "heightIn": 11 },
      { "id": "legal", "label": "Legal", "widthIn": 8.5, "heightIn": 14 },
      { "id": "a4", "label": "A4", "widthIn": 8.27, "heightIn": 11.69 },
      { "id": "a5", "label": "A5", "widthIn": 5.83, "heightIn": 8.27 }
    ],
    "orientationOptions": [
      { "id": "portrait", "label": "Portrait" },
      { "id": "landscape", "label": "Landscape" }
    ],
    "marginPresets": [
      {
        "id": "normal",
        "label": "Normal",
        "marginsIn": { "top": 1, "right": 1, "bottom": 1, "left": 1 }
      },
      {
        "id": "narrow",
        "label": "Narrow",
        "marginsIn": { "top": 0.5, "right": 0.5, "bottom": 0.5, "left": 0.5 }
      },
      {
        "id": "moderate",
        "label": "Moderate",
        "marginsIn": { "top": 1, "right": 0.75, "bottom": 1, "left": 0.75 }
      },
      {
        "id": "wide",
        "label": "Wide",
        "marginsIn": { "top": 1, "right": 2, "bottom": 1, "left": 2 }
      },
      {
        "id": "mirrored",
        "label": "Mirrored",
        "marginsIn": { "top": 1, "right": 0.75, "bottom": 1, "left": 0.75 },
        "mirrored": true
      },
      {
        "id": "custom",
        "label": "Custom",
        "marginsIn": { "top": 1, "right": 1, "bottom": 1, "left": 1 },
        "customizable": true
      }
    ],
    "gutter": {
      "defaultIn": 0,
      "minIn": 0,
      "maxIn": 2,
      "stepIn": 0.05,
      "positions": [
        { "id": "left", "label": "Left" },
        { "id": "top", "label": "Top" }
      ],
      "defaultPosition": "left"
    },
    "headerFooter": {
      "headerDistanceDefaultIn": 0.5,
      "footerDistanceDefaultIn": 0.5,
      "minDistanceIn": 0,
      "maxDistanceIn": 3,
      "stepIn": 0.05,
      "toggles": {
        "differentFirstPageDefault": false,
        "differentOddEvenDefault": false
      }
    },
    "pagination": {
      "engine": "truePagination",
      "usesMeasuredMetrics": true,
      "derivePxFromInchesUsingDpiToken": true,
      "contentRectPolicy": {
        "subtractMargins": true,
        "subtractHeaderFooterDistances": false,
        "includeGutterInLeftMarginWhenPositionLeft": true
      },
      "tokens": {
        "pageWidthVar": "--doc-page-width",
        "pageHeightVar": "--doc-page-height",
        "contentWidthVar": "--doc-content-width",
        "contentHeightVar": "--doc-content-height",
        "marginTopVar": "--doc-margin-top",
        "marginRightVar": "--doc-margin-right",
        "marginBottomVar": "--doc-margin-bottom",
        "marginLeftVar": "--doc-margin-left",
        "gutterVar": "--doc-gutter",
        "pageGapVar": "--doc-page-gap"
      }
    }
  },
  "domContracts": {
    "classNames": {
      "host": "leditor-ribbon-host",
      "shell": "leditor-ribbon-shell",
      "tabStrip": "leditor-ribbon-tabs",
      "tab": "leditor-ribbon-tab",
      "panels": "leditor-ribbon-panels",
      "panel": "leditor-ribbon-panel",
      "groupsStrip": "leditor-ribbon-groups",
      "group": "leditor-ribbon-group",
      "groupBody": "leditor-ribbon-group-body",
      "groupFooter": "leditor-ribbon-group-footer",
      "groupTitle": "leditor-ribbon-group-title",
      "dialogLauncher": "ribbon-dialog-launcher-btn",
      "cluster": "ribbon-cluster",
      "clusterLayoutPrefix": "ribbon-cluster--",
      "separator": "ribbonSeparator",
      "overflowButton": "ribbon-overflow-button",
      "groupFlyout": "ribbon-group-flyout",
      "groupCollapsedButton": "ribbon-group-button"
    },
    "attributes": {
      "activeTab": "data-active-tab",
      "collapseStage": "data-collapse-stage",
      "ribbonFixedHeight": "data-ribbon-fixed-height",
      "tabScroll": "data-ribbon-tab-scroll",
      "controlId": "data-control-id",
      "groupId": "data-group-id",
      "maxRowsVar": "--r-group-max-rows"
    }
  },
  "layout": {
    "panel": {
      "fixedHeight": true,
      "enforcePanelHeight": true,
      "groupsStripOverflowX": "auto",
      "groupsStripOverflowY": "hidden"
    },
    "group": {
      "useGridBody": true,
      "grid": {
        "autoFlow": "column dense",
        "autoColumns": "minmax(120px, max-content)",
        "maxRowsByGroupRef": "maxRowsByGroup",
        "hideOverflowY": true
      },
      "footer": {
        "showTitle": true,
        "uppercaseTitle": true,
        "titleLetterSpacingEm": 0.04
      }
    },
    "clusterLayouts": {
      "row": {
        "display": "flex",
        "flexDirection": "row",
        "alignItems": "center",
        "gapVar": "--r-ctl-gap",
        "wrap": false
      },
      "column": {
        "display": "flex",
        "flexDirection": "column",
        "alignItems": "stretch",
        "gapVar": "--r-ctl-gap",
        "wrap": false
      },
      "grid": {
        "display": "grid",
        "templateColumns": "repeat(auto-fit, minmax(32px, 1fr))",
        "gapVar": "--r-ctl-gap"
      },
      "segmented": {
        "display": "grid",
        "autoFlow": "column",
        "gapPx": 2,
        "segmentedBorders": true
      },
      "gallery": {
        "display": "grid",
        "gapPx": 4
      }
    }
  },
  "separators": {
    "strategies": {
      "defaultGroupSeparators": {
        "type": "dom",
        "insertBetween": "groups",
        "className": "ribbonSeparator",
        "insetYVar": "--r-separator-inset-y",
        "thicknessVar": "--r-separator-thickness",
        "colorTokenPath": "tokens.divider"
      }
    }
  },
  "zIndexPlan": {
    "ribbonSurface": 10,
    "menusAndPickers": 2100,
    "modals": 3000,
    "portalElementId": "ribbon-portal"
  },
  "portal": {
    "attachTo": "document.body",
    "idFromZIndexPlan": true,
    "positioning": {
      "strategy": "fixed",
      "defaultPlacement": "bottom-start",
      "offsetPx": 4,
      "constrainToViewport": true,
      "flip": true,
      "shift": true
    }
  },
  "collapse": {
    "stages": ["A", "B", "C"],
    "stageMeaning": {
      "A": "Full layout",
      "B": "Compact layout with explicit per-control consolidation/overflow",
      "C": "Collapsed groups rendered as group buttons opening flyouts"
    },
    "ordering": {
      "groupPrioritySort": "ascending",
      "controlPrioritySort": "ascending",
      "priorityDefault": 50
    },
    "algorithm": {
      "inputs": [
        "activeTab.groups[]",
        "availableWidthPx",
        "group.priority",
        "control.priority",
        "control.collapse.{A|B|C}"
      ],
      "procedure": [
        "Reset all groups/controls to Stage A directives.",
        "Measure total width; if fits, commit Stage A.",
        "Apply Stage B directives per control (visible/iconOnly/dropdownOnly/hidden/inOverflow/inMenuOf) and re-measure.",
        "If still overflow, collapse groups to Stage C (group buttons) starting from lowest priority until fits.",
        "If still overflow after Stage C, enable horizontal scroll on groups strip as last resort."
      ]
    },
    "overflow": {
      "scope": "perGroup",
      "autoInsertOverflowTrigger": true,
      "trigger": {
        "type": "button",
        "label": "More",
        "glyph": "",
        "className": "ribbon-overflow-button",
        "ariaLabelTemplate": "{groupId} overflow"
      },
      "preserveOrder": true,
      "preserveState": true
    },
    "stageBDirectives": {
      "supported": [
        "visible",
        "hidden",
        "iconOnly",
        "dropdownOnly",
        "compact",
        "narrow",
        "medium",
        "optional",
        "inOverflow",
        "inOverflowOf:{controlId}",
        "inMenuOf:{controlId}"
      ],
      "unknownDirectivePolicy": "throw"
    },
    "stageC": {
      "collapsedGroupButton": {
        "className": "ribbon-group-button",
        "labelSource": "group.label|group.groupId",
        "showGroupIconIfAvailable": false
      },
      "flyout": {
        "className": "ribbon-group-flyout",
        "placement": "bottom-start",
        "offsetPx": 4,
        "closeOnOutsideClick": true,
        "closeOnEscape": true,
        "restoreBodyToGroupOnClose": true
      }
    }
  },
  "interaction": {
    "tabstripKeyboard": {
      "leftRightArrowsMoveFocus": true,
      "homeEndMoveToEnds": true,
      "enterSpaceActivates": true,
      "doesNotAutoFocusPanel": true,
      "ariaActiveDescendant": false
    },
    "menuBehavior": {
      "closeOnEscape": true,
      "closeOnOutsideClick": true,
      "returnFocusToInvoker": true,
      "anchorPlacement": "bottom-start",
      "preventViewportClipping": true,
      "portalRequired": true
    },
    "focusOrder": {
      "domOrderMatchesVisualOrder": true,
      "noCssReorder": true,
      "tabIndexPolicy": "rovingTabIndex"
    }
  },
  "stateContract": {
    "kinds": {
      "boolean": { "allowed": ["true", "false"] },
      "mixed": { "represents": "multiple selections with differing values" },
      "enum": { "represents": "string enum constrained by control config" },
      "number": { "represents": "numeric value" },
      "string": { "represents": "string value" },
      "color": { "represents": "CSS color string or null" },
      "list": { "represents": "array of entries for galleries/menus" }
    },
    "bindingRules": [
      "Bindings are read-only for rendering; commands are the write path.",
      "If a binding is missing, renderer must treat it as 'unknown' and render an indeterminate state (no throw).",
      "If binding kind is incompatible with control state kind, renderer must throw in dev mode and warn in prod mode."
    ],
    "devMode": {
      "throwOnUnknownBindingKind": true,
      "warnOnMissingBinding": true
    }
  },
  "rendering": {
    "strictValidation": true,
    "missingFieldsPolicy": "throw",
    "unknownControlTypePolicy": "throw",
    "unknownClusterLayoutPolicy": "throw",
    "unknownIconKeyPolicy": "warn",
    "measurement": {
      "useResizeObserver": true,
      "recomputeOnFontLoad": true,
      "batchWithRaf": true
    },
    "cssTokenApplication": {
      "applyTo": ":root",
      "method": "style.setProperty",
      "prefix": "--r-",
      "applyBeforeFirstRender": true
    }
  },
  "maxRowsByGroup": {
    "clipboard": 2,
    "font": 3,
    "paragraph": 3,
    "styles": 2,
    "editing": 2,
    "default": 3
  },
  "iconPolicy": {
    "namespaces": ["icon."],
    "resolver": {
      "function": "resolveIcon",
      "input": "iconKey",
      "output": "svgString"
    },
    "fallback": {
      "missingIconBehavior": "usePlaceholder",
      "placeholderIconKey": "icon.citation"
    }
  },
  "validation": {
    "visual": {
      "reference": "Microsoft Word screenshots",
      "dpiScales": [1, 1.25, 1.5, 2],
      "widthBreakpointsPx": [960, 1024, 1280, 1440, 1920],
      "checks": [
        "Tab baseline and active underline thickness",
        "Group title baseline alignment",
        "Group separators align to panel padding",
        "Control sizing consistency (small/medium/large)",
        "Grid body respects max rows per group",
        "Deterministic collapse transitions without jitter",
        "No clipping of menus/flyouts"
      ]
    },
    "functional": {
      "checks": [
        "All controls dispatch configured command.id",
        "Toggle and mixed states render correctly",
        "Overflow menus preserve order and reflect state",
        "Menus close correctly and return focus",
        "Stage C flyouts restore group body on close",
        "Document layout commands update page metrics (size/orientation/margins) and trigger repagination deterministically"
      ]
    },
    "structural": {
      "checks": [
        "Exactly one active tab and one active panel",
        "Group count matches tab config",
        "No orphaned controls rendered outside group containers",
        "No duplicate controlId within a tab",
        "No duplicate groupId within a tab"
      ]
    }
  },
  "rollback": {
    "featureFlagKey": "ribbon.enabled",
    "immediate": [
      "Disable ribbon.enabled to restore legacy UI.",
      "Revert renderer entry point to legacy toolbar if flag unavailable."
    ],
    "partial": [
      "Keep TabStrip but render legacy panel content.",
      "Disable Stage B and Stage C collapse logic.",
      "Force Stage A only (no overflow)."
    ],
    "configRollback": [
      "Revert ribbon.json and tab JSON files to last known-good versions."
    ]
  },
  "deliverables": [
    "layout_plan.md",
    "layout.json",
    "src/ui/ribbon.ts",
    "src/ui/ribbon_layout.ts",
    "src/ui/toolbar_styles.ts",
    "src/ui/ribbon.css",
    "src/ui/pagination/paginator.ts",
    "src/ui/pagination/page_model.ts",
    "Plans/ribbon.json",
    "Plans/home.json",
    "Plans/insert.json",
    "Plans/view.json"
  ],
  "notes": [
    "Separator behavior is explicitly configured; prefer DOM separators for pixel-perfect alignment and deterministic measurement.",
    "Avoid conflicting CSS systems: class names in domContracts should match rendered DOM exactly and be the only styling targets.",
    "Do not override .leditor-ribbon-group-body to flex; group body should remain grid for Word-like layouts.",
    "Document layout header keys are owned by documentLayout and must be the single source for page metrics in both on-screen pagination and print preview."
  ]
}
